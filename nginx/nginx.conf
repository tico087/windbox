events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    server {
        listen 80;
        server_name localhost;

        # ======================================================================
        # NOVO/AJUSTADO: Configurações para o projeto PHP Puro (WindBox)
        # Ex: http://localhost/php/api/windbox/store
        # Este bloco reescreve a URI para que o bloco PHP-FPM possa processá-la.
        # ======================================================================
        location /php/ {
            # Reescreve a URI internamente para que o Nginx
            # possa passá-la para o bloco FastCGI abaixo.
            # Ex: /php/api/windbox/store -> /index.php/api/windbox/store
            # O 'last' faz com que o Nginx pare de processar as diretivas de location atuais
            # e reinicie a busca por uma nova location para a URI reescrita.
            rewrite ^/php/(.*)$ /index.php/$1 last;
        }

        # ======================================================================
        # NOVO/AJUSTADO: Bloco para processar arquivos PHP via FastCGI (php-fpm)
        # Este bloco precisa estar *fora* do `location /php/`
        # e *depois* dele no arquivo nginx.conf para que a reescrita funcione.
        # Ele captura qualquer URI que tenha sido reescrita para iniciar com /index.php
        # (ou requisições diretas a arquivos .php)
        # ======================================================================
        location ~ ^/index.php(/.*)?$ { # Captura /index.php ou /index.php/algum/caminho
            # fastcgi_split_path_info: Divide a URI em SCRIPT_FILENAME e PATH_INFO.
            # Ex: /index.php/api/windbox/store -> $1 = /index.php, $2 = /api/windbox/store
            fastcgi_split_path_info ^(.+\.php)(/.+)$;

            # Encaminha a requisição para o serviço php (PHP-FPM) na porta 9000
            fastcgi_pass php:9000;
            fastcgi_index index.php; # Arquivo padrão para requisições FastCGI

            include fastcgi_params; # Inclui parâmetros FastCGI padrão

            # Define o caminho absoluto para o script PHP *dentro do container php*.
            # Este é o ponto mais crítico e onde o "File not found" geralmente ocorre.
            # Certifique-se de que `/var/www/html/public/index.php` é o caminho correto no container `php`.
            fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
            # Passa o restante da URI (após o index.php) como PATH_INFO para o PHP.
            # Seu roteador PHP puro usará esta variável.
            fastcgi_param PATH_INFO $fastcgi_path_info;

            # Opcional: passa a URI original completa para o PHP, caso o roteador precise.
            fastcgi_param REQUEST_URI $request_uri;
            fastcgi_param HTTP_PROXY ""; # Proteção contra HTTPoxy (boa prática)
        }

    }
}